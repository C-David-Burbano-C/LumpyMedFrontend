<div class="min-h-screen bg-dark-bg/70">
  <!-- Header/Navigation -->
  <header class="glass-effect border-b border-dark-border sticky top-0 z-50">
    <div class="modern-container py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-accent-primary/10 rounded-lg">
            <img src="assets/logo.svg" alt="Logo" class="w-6 h-6">
          </div>
          <div>
            <h1 class="text-xl font-bold text-text-primary">{{ 'CALCULATOR.TITLE' | translate }}</h1>
            <p class="text-xs text-text-tertiary">Sistema de cálculo inteligente</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <a routerLink="/medicines" *ngIf="isAdmin" 
             class="modern-btn-secondary text-sm px-4 py-2">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
            Medicamentos
          </a>
          <a routerLink="/calendar" 
             class="modern-btn-secondary text-sm px-4 py-2">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Calendario
          </a>
          <button (click)="logout()" class="modern-btn-danger text-sm px-4 py-2">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            Salir
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="modern-container py-8">
    <div class="max-w-4xl mx-auto">
      <!-- Calculator Card -->
      <div class="modern-card animate-fade-in">
        <div class="flex items-center space-x-3 mb-6">
          <div class="p-3 bg-gradient-to-br from-accent-primary to-accent-purple rounded-xl">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-text-primary">Calcular Dosis</h2>
            <p class="text-sm text-text-secondary">Ingresa los datos del paciente</p>
          </div>
        </div>

        <form [formGroup]="calculatorForm" (ngSubmit)="calculateDose()" class="space-y-6">
          <!-- Medicine Selection -->
          <div>
            <label class="block text-sm font-medium text-text-secondary mb-2">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
              </svg>
              {{ 'CALCULATOR.MEDICINE' | translate }}
            </label>
            <input 
              type="text" 
              formControlName="medicineName"
              [matAutocomplete]="auto"
              maxlength="20"
              class="modern-input"
              placeholder="Buscar medicamento..."
            />
            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayMedicine">
              <mat-option *ngFor="let medicine of filteredMedicines$ | async" 
                          [value]="medicine"
                          class="bg-dark-elevated hover:bg-dark-hover text-text-primary border-b border-dark-border/30">
                <div class="py-2">
                  <div class="font-medium">{{ medicine.name }}</div>
                  <div class="text-xs text-text-tertiary">{{ medicine.description }}</div>
                </div>
              </mat-option>
            </mat-autocomplete>
            <p *ngIf="f['medicineName'].errors?.['required'] && f['medicineName'].touched" 
               class="error-message">
              {{ 'VALIDATION.REQUIRED' | translate }}
            </p>
            <p *ngIf="f['medicineName'].errors?.['maxlength'] && f['medicineName'].touched" 
               class="error-message">
              El nombre del medicamento no puede exceder 20 caracteres
            </p>
          </div>

          <!-- Weight Input -->
          <div>
            <label class="block text-sm font-medium text-text-secondary mb-2">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
              </svg>
              {{ 'CALCULATOR.WEIGHT' | translate }}
            </label>
            <input 
              type="number" 
              formControlName="weightKg" 
              maxlength="2"
              (input)="limitInput('weightKg', 2)"
              pattern="[0-9]{1,4}(\.[0-9]{1,2})?"
              class="modern-input"
              placeholder="Peso del paciente"
            />
            <p *ngIf="f['weightKg'].errors?.['required'] && f['weightKg'].touched" 
               class="error-message">
              {{ 'VALIDATION.REQUIRED' | translate }}
            </p>
            <p *ngIf="f['weightKg'].errors?.['min'] && f['weightKg'].touched" 
               class="error-message">
              {{ 'VALIDATION.MIN_VALUE' | translate: {value: 0.1} }}
            </p>
            <p *ngIf="f['weightKg'].errors?.['maxlength'] && f['weightKg'].touched" 
               class="error-message">
              El peso no puede exceder 2 caracteres
            </p>
          </div>

          <!-- Calculate Button -->
          <button 
            type="submit" 
            class="w-full modern-btn-primary"
            [disabled]="loading || calculatorForm.invalid"
          >
            <span *ngIf="!loading" class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
              </svg>
              {{ 'CALCULATOR.CALCULATE' | translate }}
            </span>
            <span *ngIf="loading" class="flex items-center justify-center">
              <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
              {{ 'COMMON.LOADING' | translate }}
            </span>
          </button>
        </form>

        <!-- Error Message -->
        <div *ngIf="errorMessage" class="mt-6 badge-danger px-4 py-3 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span>{{ errorMessage }}</span>
          </div>
        </div>
      </div>

      <!-- Results Card -->
      <div *ngIf="doseResult" class="modern-card mt-6 animate-slide-up">
        <div class="flex items-center space-x-3 mb-6">
          <div class="p-3 rounded-xl" 
               [ngClass]="{
                 'bg-gradient-to-br from-accent-success to-accent-primary': isResultSafe(),
                 'bg-gradient-to-br from-accent-warning to-accent-danger': !isResultSafe()
               }">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-xl font-bold text-text-primary">{{ 'CALCULATOR.RESULT' | translate }}</h3>
            <p class="text-sm text-text-secondary">{{ doseResult.medicine.name }}</p>
          </div>
        </div>

        <!-- Alert Message -->
        <div class="mb-4 p-4 rounded-lg border"
             [ngClass]="{
               'bg-accent-success/10 border-accent-success': isResultSafe(),
               'bg-accent-warning/10 border-accent-warning': !isResultSafe()
             }">
          <div class="flex items-start">
            <svg class="w-5 h-5 mt-0.5 mr-2 flex-shrink-0" 
                 [ngClass]="{
                   'text-accent-success': isResultSafe(),
                   'text-accent-warning': !isResultSafe()
                 }"
                 fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm" 
                  [ngClass]="{
                    'text-accent-success': isResultSafe(),
                    'text-accent-warning': !isResultSafe()
                  }">
              {{ doseResult.alert }}
            </span>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Daily Dose (mg) -->
          <div class="bg-dark-elevated border border-dark-border rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-text-secondary">Dosis diaria total</span>
              <svg class="w-5 h-5 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
              </svg>
            </div>
            <p class="text-3xl font-bold gradient-text">{{ doseResult.mgPerDay | number:'1.2-2' }} mg</p>
            <p class="text-xs text-text-tertiary mt-1">Por día</p>
          </div>

          <!-- Doses per Day -->
          <div class="bg-dark-elevated border border-dark-border rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-text-secondary">Frecuencia</span>
              <svg class="w-5 h-5 text-accent-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <p class="text-3xl font-bold text-accent-purple">{{ doseResult.dosesPerDay }}</p>
            <p class="text-xs text-text-tertiary mt-1">Dosis por día</p>
          </div>

          <!-- Dose per administration (mg) -->
          <div class="bg-dark-elevated border border-dark-border rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-text-secondary">Dosis por toma (mg)</span>
              <svg class="w-5 h-5 text-accent-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
              </svg>
            </div>
            <p class="text-3xl font-bold text-accent-success">{{ doseResult.mgPerDose | number:'1.2-2' }} mg</p>
            <p class="text-xs text-text-tertiary mt-1">Por administración</p>
          </div>

          <!-- Volume to administer (ml) -->
          <div class="bg-dark-elevated border border-accent-warning rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-text-secondary">Volumen a administrar</span>
              <svg class="w-5 h-5 text-accent-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
              </svg>
            </div>
            <p class="text-4xl font-bold text-accent-warning">{{ doseResult.mlPerDose | number:'1.2-2' }} ml</p>
            <p class="text-xs text-text-tertiary mt-1">Por cada administración</p>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="mt-4 p-4 bg-dark-elevated border border-dark-border rounded-lg">
          <h4 class="text-sm font-medium text-text-secondary mb-3">Información del medicamento</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div>
              <span class="text-text-tertiary">Nombre:</span>
              <span class="text-text-primary font-medium ml-2">{{ doseResult.medicine.name || 'N/A' }}</span>
            </div>
            <div>
              <span class="text-text-tertiary">Paciente:</span>
              <span class="text-text-primary font-medium ml-2">{{ doseResult.weightKg }} kg</span>
            </div>
            <div>
              <span class="text-text-tertiary">Dosis (mg/kg/día):</span>
              <span class="text-text-primary font-medium ml-2">{{ doseResult.medicine.mgKgDay || 'N/A' }} mg</span>
            </div>
            <div>
              <span class="text-text-tertiary">Frecuencia:</span>
              <span class="text-text-primary font-medium ml-2">{{ doseResult.medicine.dosesPerDay || doseResult.dosesPerDay || 'N/A' }} dosis/día</span>
            </div>
            <div>
              <span class="text-text-tertiary">Concentración:</span>
              <span class="text-text-primary font-medium ml-2">{{ doseResult.medicine.concentrationMg || 'N/A' }}mg / {{ doseResult.medicine.concentrationMl || 'N/A' }}ml</span>
            </div>
            <div>
              <span class="text-text-tertiary">Rango seguro (ml):</span>
              <span class="text-text-primary font-medium ml-2">{{ doseResult.safeRange || 'N/A' }}</span>
            </div>
          </div>
          <p *ngIf="doseResult.medicine.description" class="mt-3 text-sm text-text-secondary border-t border-dark-border pt-3">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ doseResult.medicine.description }}
          </p>
        </div>

        <!-- AI Medical Advice Section -->
        <div class="mt-4 p-4 bg-gradient-to-br from-accent-primary/5 to-accent-purple/5 border border-accent-primary/20 rounded-lg">
          <div class="flex items-center space-x-3 mb-4">
            <div class="p-2 bg-gradient-to-br from-accent-primary to-accent-purple rounded-lg">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
            </div>
            <div>
              <h4 class="text-lg font-semibold text-text-primary">Consejos de IA Médica</h4>
              <p class="text-sm text-text-secondary">Recomendaciones inteligentes basadas en el cálculo</p>
            </div>
          </div>

          <div *ngIf="aiLoading" class="flex items-center justify-center py-8">
            <div class="text-center">
              <div class="animate-spin rounded-full h-4 w-4 border-2 border-accent-primary border-t-transparent mb-3"></div>
              <p class="text-sm text-text-secondary">Generando consejos médicos...</p>
            </div>
          </div>

          <!-- AI Error State -->
          <div *ngIf="aiError && !aiLoading" class="bg-accent-danger/10 border border-accent-danger/20 rounded-lg p-4">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-accent-danger mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <p class="text-sm font-medium text-accent-danger">Error al generar consejos</p>
                <p class="text-sm text-text-secondary mt-1">{{ aiError }}</p>
                <button (click)="generateAiAdvice(doseResult!)" class="mt-2 text-sm text-accent-primary hover:text-accent-primary/80 underline">
                  Reintentar
                </button>
              </div>
            </div>
          </div>

          <!-- AI Advice Content -->
          <div *ngIf="aiAdvice && !aiLoading && !aiError" class="space-y-4">
            <!-- Main Advice -->
            <div *ngIf="aiAdvice.advice" class="bg-dark-elevated border border-dark-border rounded-lg p-4">
              <h5 class="text-sm font-medium text-text-primary mb-2 flex items-center">
                <svg class="w-4 h-4 mr-2 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Consejos Generales
              </h5>
              <p class="text-sm text-text-secondary leading-relaxed">{{ aiAdvice.advice }}</p>
            </div>

            <!-- Recommendations -->
            <div *ngIf="aiAdvice.recommendations && aiAdvice.recommendations.length > 0" class="bg-accent-success/10 border border-accent-success/20 rounded-lg p-4">
              <h5 class="text-sm font-medium text-accent-success mb-3 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Recomendaciones
              </h5>
              <ul class="space-y-2">
                <li *ngFor="let recommendation of aiAdvice.recommendations" class="text-sm text-text-secondary flex items-start">
                  <span class="text-accent-success mr-2 mt-1">•</span>
                  <span>{{ recommendation }}</span>
                </li>
              </ul>
            </div>

            <!-- Warnings -->
            <div *ngIf="aiAdvice.warnings && aiAdvice.warnings.length > 0" class="bg-accent-warning/10 border border-accent-warning/20 rounded-lg p-4">
              <h5 class="text-sm font-medium text-accent-warning mb-3 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                Precauciones Importantes
              </h5>
              <ul class="space-y-2">
                <li *ngFor="let warning of aiAdvice.warnings" class="text-sm text-text-secondary flex items-start">
                  <span class="text-accent-warning mr-2 mt-1">⚠️</span>
                  <span>{{ warning }}</span>
                </li>
              </ul>
            </div>

            <!-- Disclaimer -->
            <div class="bg-dark-elevated/50 border border-dark-border/50 rounded-lg p-3">
              <p class="text-xs text-text-tertiary text-center">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Estos consejos son informativos y no reemplazan la consulta con un profesional de la salud.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
